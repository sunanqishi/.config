/*! (c) Philipp König under GPL-3.0 */
(e=>{"use strict";e.EntryHelper=function(e){let t=!1,a={},n={},l={},r={bookmarks:{},directories:{},pinned:{}};this.init=e=>(t=!0,new Promise(t=>{this.update(e).then(t)})),this.initOnce=()=>new Promise(e=>{t?e():this.init().then(e)}),this.getAmount=t=>{if(i(),0===Object.keys(a).length&&(a=e.helper.model.getData("u/entryAmounts")),a&&a[t]){let e=a[t].visible;return n.showHidden&&(e+=a[t].hidden),e}return null},this.getAllDataByType=e=>Object.values(r[e]||{}),this.getDataById=e=>{let t=null;return"object"==typeof r.bookmarks[e]?(t=r.bookmarks[e],"object"==typeof r.pinned[e]&&(t.pinnedIndex=r.pinned[e].index)):"object"==typeof r.directories[e]&&(t=r.directories[e]),t},this.getParentsById=e=>{const t=[];try{let a=this.getDataById(e).parentId;for(;a;){const e=this.getDataById(a);e&&t.push(e),a=e&&e.parentId?e.parentId:null}}catch(e){}return t},this.addData=(e,t,a)=>{"object"==typeof r.bookmarks[e]?("pinnedIndex"===t&&"object"==typeof r.pinned[e]&&(r.pinned[e].index=a),r.bookmarks[e][t]=a):"object"==typeof r.directories[e]&&(r.directories[e][t]=a)},this.isSeparator=e=>{let t=!1;return"object"==typeof r.bookmarks[e]&&(t="about:blank"===r.bookmarks[e].url&&/^[-_]{3,}/.test(r.bookmarks[e].title)&&/[-_]{3,}$/.test(r.bookmarks[e].title)),t},this.isVisible=e=>{let t=!1;return"object"==typeof r.bookmarks[e]?t=!1===r.bookmarks[e].hidden:"object"==typeof r.directories[e]&&(t=!1===r.directories[e].hidden),t},this.update=(t=null)=>new Promise(n=>{i();const o=[e.helper.model.call("viewAmounts")];null===t&&o.push(e.helper.model.call("bookmarks",{id:0})),Promise.all(o).then(i=>{l=i[0],null===t&&i[1]&&i[1].bookmarks&&i[1].bookmarks[0]&&i[1].bookmarks[0].children&&(t=i[1].bookmarks[0].children),r={bookmarks:{},directories:{},pinned:{}},a={bookmarks:{visible:0,hidden:0},directories:{visible:0,hidden:0},pinned:{visible:0,hidden:0}},s(t),e.helper.model.setData({"u/entryAmounts":a}),n()})});const i=()=>{n=e.helper.model.getData(["u/hiddenEntries","u/additionalInfo","u/pinnedEntries","u/showHidden"])},s=(e,t=[],a=!1)=>{e.forEach(e=>{const r=[...t];"0"!==e.parentId&&r.push(e.parentId),e.additionalInfo=n.additionalInfo[e.id]||{},e.hidden=a||!0===n.hiddenEntries[e.id],e.parents=r,e.views={startDate:+new Date(Math.max(e.dateAdded,l.counterStartDate)),total:0},e.url?c(e):e.children&&o(e)})},o=e=>{e.childrenAmount={bookmarks:0,directories:0,total:0},e.parents.forEach(e=>{r.directories[e].childrenAmount.directories++}),r.directories[e.id]=e,s(e.children,e.parents,e.hidden),e.isDir=!0,e.childrenAmount.total=e.childrenAmount.bookmarks+e.childrenAmount.directories,e.views.perMonth=Math.round(e.views.total/p(e.views.startDate)*100)/100,a.directories[e.hidden?"hidden":"visible"]++},c=e=>{let t=0,i=0;if(l.viewAmounts[e.id]&&(t=l.viewAmounts[e.id].c,i=l.viewAmounts[e.id].d||0),e.views.total=t,e.views.lastView=i,e.views.perMonth=Math.round(t/p(e.views.startDate)*100)/100,e.parents.forEach(e=>{r.directories[e]&&(r.directories[e].childrenAmount.bookmarks++,r.directories[e].views.total+=t,r.directories[e].views.lastView=Math.max(r.directories[e].views.lastView||0,i))}),e.pinned=!1,r.bookmarks[e.id]=e,!1===this.isSeparator(e.id)&&a.bookmarks[e.hidden?"hidden":"visible"]++,n.pinnedEntries[e.id]){e.pinned=!0;const t=Object.assign({},e);t.index=n.pinnedEntries[e.id].index,delete t.parents,delete t.parentId,r.pinned[e.id]=t,a.pinned[e.hidden?"hidden":"visible"]++}},p=e=>Math.max(1,Math.round((+new Date-e)/2627999942.4))},e.EditHelper=function(t){let a=!1;this.init=async()=>{e("<a />").addClass(e.cl.newtab.edit).appendTo(t.elm.body),n(),location.href.search(/#edit$/i)>-1&&i()},this.isEditMode=()=>a;const n=()=>{t.elm.body.on("click","a."+e.cl.newtab.edit,e=>{e.preventDefault(),a||i()})},l=()=>new Promise(a=>{const n=[];t.elm.topNav.find("a."+e.cl.newtab.link).forEach(t=>{const a=e(t).text().trim(),l=e(t).data("href").trim();a&&a.length>0&&l&&l.length>0&&n.push({label:a,url:l})});const l=+new Date,r=t.helper.template.loading().appendTo(t.elm.body);t.elm.body.addClass(e.cl.loading);const i=t.helper.search.getCurrentSearchEngine(),s=i.name;delete i.name;const o={"n/searchField":t.elm.search.wrapper.children("select["+e.attr.type+"='searchField']")[0].value,"n/searchEngine":s,"n/searchEngineCustom":i,"n/topPagesType":t.elm.topPages.children("select["+e.attr.type+"='type']")[0].value,"n/shortcutsPosition":t.elm.topNav.children("select")[0].value,"n/shortcuts":n};"premium"===t.helper.model.getUserType()&&t.elm.topPages.children("select["+e.attr.type+"='appearance']").length()>0&&(o["n/topPagesAppearance"]=t.elm.topPages.children("select["+e.attr.type+"='appearance']")[0].value),t.helper.model.setData(o).then(()=>{const a=t.elm.body.css("background-image").replace(/(^url\("?|"?\)$)/g,"");return new Promise(t=>{e.api.storage.local.set({newtabBackground_1:a&&"none"!==a?a:null},()=>{e.api.runtime.lastError,t()})})}).then(()=>e.delay(Math.max(0,1e3-(+new Date-l)))).then(()=>{t.elm.body.removeClass(e.cl.loading),r.remove(),a()})}),r=()=>{a=!1,history.pushState({},null,location.href.replace(/#edit/g,"")),t.elm.body.removeClass(e.cl.newtab.edit),t.elm.search.wrapper.children("a."+e.cl.newtab.edit).remove(),t.elm.search.wrapper.children("select").remove(),t.elm.topPages.children("select").remove(),t.elm.topNav.children("select").remove(),t.elm.topNav.find("a:not(."+e.cl.newtab.link+")").remove(),t.helper.search.updateSearchEngine(t.helper.model.getData("n/searchEngine"),t.helper.model.getData("n/searchEngineCustom")),t.helper.search.setVisibility(t.helper.model.getData("n/searchField")),t.helper.topPages.setType(t.helper.model.getData("n/topPagesType")),t.helper.topPages.setAppearance(t.helper.model.getData("n/topPagesAppearance")),t.helper.shortcuts.refreshEntries(),t.getBackground().then(e=>{t.setBackground(e)}),e.delay(500).then(()=>{e("menu."+e.cl.newtab.infoBar).remove()})},i=()=>{a=!0,history.pushState({},null,location.href.replace(/#edit/g,"")+"#edit");const n=e("<menu />").addClass(e.cl.newtab.infoBar).append("<a class='"+e.cl.newtab.cancel+"'>"+t.helper.i18n.get("overlay_cancel")+"</a>").append("<a class='"+e.cl.newtab.save+"'>"+t.helper.i18n.get("settings_save")+"</a>").appendTo(t.elm.body),i=e("<div />").addClass(e.cl.newtab.upload).appendTo(n);"premium"===t.helper.model.getUserType()?(e("<a />").addClass(e.cl.newtab.remove).appendTo(i),e("<div />").html("<span>"+t.helper.i18n.get("newtab_upload_background")+'</span><input type="file" accept="image/*" />').appendTo(i)):(i.attr("title",t.helper.i18n.get("premium_restricted_text")),e("<span />").text(t.helper.i18n.get("settings_menu_premium")).addClass(e.cl.premium).appendTo(i),e("<div />").html("<span>"+t.helper.i18n.get("newtab_upload_background")+"</span>").appendTo(i)),e("menu."+e.cl.newtab.infoBar+" > a").on("click",t=>{t.preventDefault();const a=e(t.currentTarget);a.hasClass(e.cl.newtab.cancel)?r():a.hasClass(e.cl.newtab.save)&&l().then(()=>{r()})}),"premium"===t.helper.model.getUserType()?(e("menu."+e.cl.newtab.infoBar+" > div."+e.cl.newtab.upload+" input").on("change",a=>{if(a.currentTarget.files){const n=new FileReader;n.onload=a=>{try{t.elm.body.addClass(e.cl.newtab.customBackground).css("background-image","url("+a.target.result+")")}catch(a){}},n.readAsDataURL(a.currentTarget.files[0])}}),e("menu."+e.cl.newtab.infoBar+" > div."+e.cl.newtab.upload+" a."+e.cl.newtab.remove).on("click",()=>{t.elm.body.removeClass(e.cl.newtab.customBackground).css("background-image","")})):e("menu."+e.cl.newtab.infoBar+" > div."+e.cl.newtab.upload).on("click",()=>{t.helper.model.call("openLink",{href:e.api.extension.getURL("html/settings.html#premium"),newTab:!0})}),e.delay().then(()=>{t.elm.body.addClass(e.cl.newtab.edit),d(),c(),s(),"premium"===t.helper.model.getUserType()&&p(),e.delay(500).then(()=>{e(window).trigger("resize")})})},s=()=>{const a=["<a class='"+e.cl.newtab.edit+"' />","<a class='"+e.cl.newtab.remove+"' />","<a "+e.attr.position+"='left' />","<a "+e.attr.position+"='right' />"];t.elm.topNav.find("> ul > li").forEach(t=>{e(t).append(a)});const n=t.helper.model.getData("n/shortcutsPosition"),l=e("<select />").addClass(e.cl.newtab.edit).appendTo(t.elm.topNav);["left","right"].forEach(a=>{e("<option value='"+a+"' "+(n===a?"selected":"")+" />").text(t.helper.i18n.get("settings_sidebar_position_"+a)).appendTo(l)}),l.on("input change",a=>{t.elm.topNav.attr(e.attr.position,a.currentTarget.value)}),e("<a class='"+e.cl.newtab.add+"' />").prependTo(t.elm.topNav),t.elm.topNav.off("click.edit").on("click.edit","a."+e.cl.newtab.edit,t=>{t.stopPropagation();const a=e(t.currentTarget).parent("li");o(a)}).on("click.edit","a."+e.cl.newtab.add,()=>{const n=e("<li />").append("<a class='"+e.cl.newtab.link+"'>&nbsp;</a>").append(a).prependTo(t.elm.topNav.children("ul"));e.delay().then(()=>{o(n)})}).on("click.edit","a."+e.cl.newtab.remove,t=>{e(t.currentTarget).parent("li").remove()}).on("click.edit","a["+e.attr.position+"]",t=>{const a=e(t.currentTarget).attr(e.attr.position),n=e(t.currentTarget).parent("li");switch(a){case"left":n.prev("li").length()>0&&n.insertBefore(n.prev("li"));break;case"right":n.next("li").length()>0&&n.insertAfter(n.next("li"))}}).on("click.edit","> ul > li > div",e=>{"BUTTON"!==e.target.tagName&&e.stopPropagation()}),e(document).off("click.edit").on("click.edit",()=>{t.elm.topNav.find("> ul > li > div").remove()})},o=a=>{t.elm.topNav.find("> ul > li > div").remove();const n=a.children("a."+e.cl.newtab.link).eq(0),l=(n.data("href")||"").trim();e("<div />").append("<label>"+t.helper.i18n.get("overlay_bookmark_title")+"</label>").append("<input type='text' value='"+n.text().trim().replace(/'/g,"&#x27;")+"' "+e.attr.type+"='label' />").append("<label>"+t.helper.i18n.get("overlay_bookmark_url")+"</label>").append("<input type='text' value='"+l.replace(/'/g,"&#x27;")+"' "+e.attr.type+"='url' />").append("<button type='submit'>"+t.helper.i18n.get("overlay_close")+"</button>").appendTo(a).find("input[type='text']").on("change input",t=>{let a=t.currentTarget.value.trim();switch(e(t.currentTarget).attr(e.attr.type)){case"url":n.removeAttr("href").removeData("href"),a&&a.length>0&&(0!==a.search(/^[\w-]+:\/\//)&&(a="http://"+a),n.data("href",a));break;case"label":a&&a.length>0?n.text(a.trim()):n.html("&nbsp;")}})},c=()=>{const a=e("<select />").addClass(e.cl.newtab.edit).attr(e.attr.type,"type").prependTo(t.elm.topPages),n=t.helper.topPages.getAllTypes(),l=t.helper.model.getData("n/topPagesType");Object.keys(n).forEach(r=>{const i=t.helper.i18n.get("newtab_top_pages_"+n[r]);e("<option value='"+r+"' "+(l===r?"selected":"")+" />").text(i).appendTo(a)}),a.on("input change",e=>{t.helper.topPages.setType(e.currentTarget.value)})},p=()=>{const a=e("<select />").addClass(e.cl.newtab.edit).attr(e.attr.type,"appearance").prependTo(t.elm.topPages),n=t.helper.model.getData("n/topPagesAppearance");t.helper.topPages.getAllAppearances().forEach(l=>{const r=t.helper.i18n.get("newtab_top_pages_appearance_"+l);e("<option value='"+l+"' "+(n===l?"selected":"")+" />").text(r).appendTo(a)}),a.on("input change",e=>{t.helper.topPages.setAppearance(e.currentTarget.value)})},d=()=>{const a=e("<select />").addClass(e.cl.newtab.edit).attr(e.attr.type,"searchField").prependTo(t.elm.search.wrapper),n=t.helper.model.getData("n/searchField");["show","hide"].forEach(l=>{const r=t.helper.i18n.get("newtab_search_field_"+l);e("<option value='"+l+"' "+(n===l?"selected":"")+" />").text(r).appendTo(a)}),a.on("input change",e=>{t.helper.search.setVisibility(e.currentTarget.value)}),e("<a />").addClass(e.cl.newtab.edit).appendTo(t.elm.search.wrapper).on("click",e=>{e.preventDefault(),t.helper.overlay.create("searchEngine",t.helper.i18n.get("newtab_search_engine_headline"))})}},e.FallbackHelper=function(t){this.init=async()=>{const l=new URL(location.href).searchParams.get("type");null!==l&&(t.elm.topPages.addClass(e.cl.hidden),t.elm.fallbackInfo.addClass(e.cl.active),r(l),a(l),"new_tab"!==l&&"fallback"!==l||!1!==t.helper.model.getData("n/override")||n())};const a=a=>{t.elm.fallbackInfo.children("a").on("click",t=>{t.preventDefault();let n="general";switch(a){case"notWhitelisted":case"blacklisted":n="filter"}e.api.tabs.create({url:e.api.extension.getURL("html/settings.html#feedback_error_"+n)})})},n=()=>{const a=e("<div />").appendTo(t.elm.fallbackInfo),n=t.helper.checkbox.get(t.elm.body,{},"checkbox","switch").appendTo(a);e("<span />").html(t.helper.i18n.get("newtab_fallback_set_as_new_tab")).insertAfter(n),n.children("input[type='checkbox']").on("change",t=>{t.currentTarget.checked?e.api.permissions.request({permissions:["tabs","topSites","history"]},e=>{e?l(!0):n.trigger("click")}):l(!1)})},l=a=>{e.api.storage.sync.get(["newtab"],n=>{const l=n.newtab||{};l.override=a,e.api.storage.sync.set({newtab:l},()=>{t.enabledSetAsNewtab=!0,t.helper.model.call("reinitialize")})})},r=a=>{const n={headline:"newtab_fallback_headline_general",desc:"newtab_fallback_desc",link:"more_link"};switch(a){case"new_tab":case"system":case"extension_page":case"webstore":n.headline="newtab_fallback_headline_"+a;break;case"notWhitelisted":case"blacklisted":n.headline="newtab_fallback_headline_url_filter"}e("<h2 />").text(t.helper.i18n.get(n.headline)).appendTo(t.elm.fallbackInfo),e("<p />").text(t.helper.i18n.get(n.desc)).appendTo(t.elm.fallbackInfo),e("<a />").text(t.helper.i18n.get(n.link)).appendTo(t.elm.fallbackInfo)}},e.OverlayHelper=function(t){let a={};this.create=(n,r)=>{switch(a=t.helper.template.overlay(n,r),a.buttonWrapper.children("a."+e.cl.close).text(t.helper.i18n.get("overlay_close")),n){case"searchEngine":l()}s()};const n=()=>{t.helper.utility.triggerEvent("overlayClosed"),a.overlay.removeClass(e.cl.page.visible),e.delay(400).then(()=>{a.overlay.remove()})},l=()=>{const n=e("<div />").addClass(e.cl.scrollBox.wrapper).appendTo(a.modal),l=e("<ul />").appendTo(n),r=t.helper.search.getSearchEngineList(),i=t.helper.search.getCurrentSearchEngine();Object.entries(r).forEach(([n,r])=>{const s=e("<li />").append(t.helper.checkbox.get(a.overlay.find("body"),{[e.attr.name]:"searchEngine",[e.attr.value]:n},"radio")).append("<a>"+r.name+"</a>").appendTo(l);r.favicon&&e("<img />").attr("src",r.favicon).prependTo(s.children("a")),i.name===n&&s.find("input["+e.attr.name+"='searchEngine']["+e.attr.value+"='"+n+"']").parent("div."+e.cl.checkbox.box).trigger("click")});const s=e("<ul />").attr(e.attr.type,"custom").appendTo(n);"custom"===i.name&&s.addClass(e.cl.visible),e("<li />").append("<label>"+t.helper.i18n.get("newtab_search_engine_custom_title")+"</label>").append("<input type='text' name='title' value='"+i.title.replace(/'/g,"&#x27;")+"' />").appendTo(s),e("<li />").append("<label>"+t.helper.i18n.get("newtab_search_engine_custom_url_homepage")+"</label>").append("<input type='text' name='homepage' value='"+i.homepage.replace(/'/g,"&#x27;")+"' placeholder='https://example.com' />").appendTo(s),e("<li />").append("<label>"+t.helper.i18n.get("newtab_search_engine_custom_url_results")+"</label>").append("<input type='text' name='queryUrl' value='"+i.queryUrl.replace(/'/g,"&#x27;")+"' placeholder='https://example.com/?q={1}' />").appendTo(s),e("<a />").addClass(e.cl.overlay.action).text(t.helper.i18n.get("overlay_save")).appendTo(a.buttonWrapper)},r=()=>{let t=null;return a.modal.find("input[type='checkbox']").forEach(a=>{if(a.checked)return t=e(a).attr(e.attr.value),!1}),t},i=()=>{const e=r();e&&t.helper.search.updateSearchEngine(e,{title:a.modal.find("input[name='title']")[0].value,homepage:a.modal.find("input[name='homepage']")[0].value,queryUrl:a.modal.find("input[name='queryUrl']")[0].value}),n()},s=()=>{let t=null;a.overlay.find("body").on("mousedown",e=>{t=e.target}).on("click",e=>{"BODY"===e.target.tagName&&"BODY"===t.tagName&&n()}),a.modal.find("a."+e.cl.close).on("click",e=>{e.preventDefault(),n()}),a.modal.on("click","a",t=>{t.preventDefault();const n=e(t.currentTarget),l=n.prev("div."+e.cl.checkbox.box);l.length()>0&&l.trigger("click"),n.hasClass(e.cl.overlay.action)&&(()=>{switch(a.modal.attr(e.attr.type)){case"searchEngine":i()}})()}),a.modal.find("input[type='checkbox']").on("change",()=>{e.delay().then(()=>{const t=a.modal.find("ul["+e.attr.type+"='custom']");"custom"===r()?t.addClass(e.cl.visible):t.removeClass(e.cl.visible)})})}},e.SearchHelper=function(t){const a={};let n={},l={},r=!1;const i={google:{name:"Google",url:"https://www.google.com/",queryUrl:"https://www.google.com/search?q={1}",favicon:"https://www.google.com/favicon.ico",sorting:10},bing:{name:"Bing",url:"https://www.bing.com/",queryUrl:"https://www.bing.com/search?q={1}",favicon:"https://www.bing.com/favicon.ico",sorting:20},yandex:{name:"Yandex",url:"https://yandex.com/",queryUrl:"https://yandex.com/search/?text={1}",favicon:"https://yandex.com/favicon.ico",sorting:30,lang:{ru:{name:"Яндекс",url:"https://yandex.ru/",queryUrl:"https://yandex.ru/search/?text={1}",sorting:15},uk:{name:"Яндекс",url:"https://yandex.ua/",queryUrl:"https://yandex.ua/search/?text={1}",sorting:15},tr:{url:"https://yandex.com.tr/",queryUrl:"https://yandex.com.tr/search/?text={1}",sorting:15}}},baidu:{name:"Baidu",url:"https://www.baidu.com/",queryUrl:"https://www.baidu.com/s?wd={1}",favicon:"https://www.baidu.com/favicon.ico",sorting:40,lang:{"zh-CN":{name:"百度",sorting:5}}},custom:{sorting:50}};this.init=async()=>{s(),p(),this.updateSearchEngine(t.helper.model.getData("n/searchEngine"),t.helper.model.getData("n/searchEngineCustom")),this.setVisibility(t.helper.model.getData("n/searchField"))},this.setVisibility=a=>{"hide"===a?t.elm.search.wrapper.addClass(e.cl.hidden):t.elm.search.wrapper.removeClass(e.cl.hidden)},this.updateSearchEngine=(e,a={})=>{if(l[e]){n={name:e,title:a.title||"",homepage:a.homepage||"",queryUrl:a.queryUrl||""};const r="custom"===n.name&&n.title?n.title:l[e].label;t.elm.search.field.attr("placeholder",t.helper.i18n.get("newtab_search_placeholder",[r]))}},this.getCurrentSearchEngine=()=>n,this.getSearchEngineList=()=>l;const s=()=>{const e=t.helper.i18n.getUILanguage(),a=[];Object.entries(i).forEach(([n,l])=>{if("custom"===n){const e=t.helper.model.getData("n/searchEngineCustom");l.name=t.helper.i18n.get("newtab_search_engine_custom"),l.label=e.title,l.url=e.homepage,l.queryUrl=e.queryUrl}const r={alias:n,name:l.name,label:l.label||l.name,favicon:l.favicon||null,url:l.url,queryUrl:l.queryUrl,sorting:l.sorting};l.lang&&l.lang[e]&&Object.entries(l.lang[e]).forEach(([e,t])=>{r[e]=t}),r.name&&a.push(r)}),a.sort((e,t)=>(e.sorting||9999)-(t.sorting||9999)),l={},a.forEach(e=>{l[e.alias]=e})},o=a=>{const n=e("ul."+e.cl.newtab.suggestions+" > li."+e.cl.active);let l="next"===a?0:-1;n.length()>0&&(l=n.prevAll("li").length()+("next"===a?1:-1),n.removeClass(e.cl.active));let r=!1;if(l>=0){const a=e("ul."+e.cl.newtab.suggestions+" > li").eq(l);a.length()>0&&(r=!0,a.addClass(e.cl.active),t.elm.search.field[0].value=(a.attr(e.attr.src)||a.text()).trim())}!1===r&&(t.elm.search.field[0].value=t.elm.search.field.data("typedVal")||"")},c=(e,a={})=>{if(!e||0===e.trim().length)return;const r=e=>{t.helper.model.call("openLink",{href:e,newTab:a.newtab||!1,position:t.helper.model.getData("b/newTabPosition"),active:!a.newtab})};if(0===e.search(/https?\:\/\//)||0===e.search(/s?ftps?\:\/\//)||0===e.search(/chrome\:\/\//))r(e);else if(l[n.name]){let t="";"custom"===n.name&&n.queryUrl?t=n.queryUrl:l[n.name].queryUrl&&(t=l[n.name].queryUrl),t&&(!1===t.includes("{1}")&&(t+="{1}"),r(t.replace("{1}",encodeURIComponent(e))))}},p=()=>{t.elm.search.speechSearch.on("click",e=>{e.preventDefault(),d()}),t.elm.search.submit.on("click",e=>{e.preventDefault(),e.stopPropagation();const a=t.elm.search.field[0].value;if(a&&a.trim().length>0)c(a);else if(l[n.name]){let e="";"custom"===n.name&&n.homepage?e=n.homepage:l[n.name].url&&(e=l[n.name].url),e&&t.helper.model.call("openLink",{href:e,newTab:!1})}}),t.elm.search.field.on("keyup click",n=>{n.preventDefault(),n.stopPropagation();const l=n.currentTarget.value.trim(),r=event.which||event.keyCode;13===r?c(l):40===r?o("next"):38===r?o("prev"):(t.elm.search.field.data("typedVal",l),(n=>new Promise(l=>{if(n)if(a[n])l(a[n]);else{const r=encodeURIComponent(n),i=(e=[])=>{a[n]=e,l(e)},s=[e.xhr("http://google.com/complete/search?client=chrome&q="+r,{responseType:"json"})];n.length>=2&&s.push(t.helper.model.call("searchBookmarks",{searchVal:n})),n.length>=3&&e.api.history&&s.push(t.helper.model.call("searchHistory",{searchVal:n})),Promise.all(s).then(([e,t,a])=>{try{const l=[],r=[];if(t&&t.bookmarks&&t.bookmarks.length>0){let e=0;t.bookmarks.some(t=>{if(t.url&&(l.push({type:"bookmark",label:t.title,url:t.url}),e++,e>=2))return!0})}if(a&&a.history&&a.history.length>0){let e=0;a.history.some(t=>{if(t.url&&(l.push({type:"history",label:t.title,url:t.url}),e++,e>=2))return!0})}e.response&&e.response.length>1&&e.response[0]===n&&e.response[1].forEach((t,a)=>{let n=t;"NAVIGATION"===e.response[4]["google:suggesttype"][a]?(n=n.replace(/^https?:\/\//,""),n=n.replace(/\/$/,""),n=n.replace(/^www\./,""),l.push({type:"url",url:t,label:n})):r.push({type:"word",label:n})}),i(l.concat(r))}catch(e){i()}},()=>{i()})}else l([])}))(l).then(a=>{if(e("ul."+e.cl.newtab.suggestions).remove(),a.length>0){const n=e("<ul />").addClass(e.cl.newtab.suggestions).insertAfter(t.elm.search.field);a.some((t,a)=>{const l=e("<li />").attr(e.attr.type,t.type).text(t.label).appendTo(n);if(t.url&&l.attr({title:t.url,[e.attr.src]:t.url}).append("<span>"+t.url+"</span>"),a>5)return!0}),n.css({top:t.elm.search.field[0].offsetTop+"px",left:t.elm.search.field[0].offsetLeft+"px"})}}))}),e(document).on("mousemove","ul."+e.cl.newtab.suggestions+" > li",t=>{e("ul."+e.cl.newtab.suggestions+" > li").removeClass(e.cl.active),e(t.currentTarget).addClass(e.cl.active)}).on("click auxclick","ul."+e.cl.newtab.suggestions+" > li",t=>{t.preventDefault(),t.stopPropagation();const a=(e(t.currentTarget).attr(e.attr.src)||e(t.currentTarget).text()).trim();c(a,{newtab:"auxclick"===t.type})}),e(document).on("keydown",a=>{"f"===a.key&&(a.ctrlKey||a.metaKey)&&(a.preventDefault(),t.sidebarHelper&&t.sidebarHelper.search&&t.elm.sidebar&&t.elm.sidebar.iframe&&(e(document).trigger(e.opts.events.openSidebar),t.elm.sidebar.iframe[0].focus(),t.sidebarHelper.search.showSearchField()))}),e(document).on("click",()=>{e("ul."+e.cl.newtab.suggestions).remove(),!1===t.helper.edit.isEditMode()&&(!1===t.elm.search.wrapper.hasClass(e.cl.hidden)?(!1===r&&(r=!0,t.elm.search.field[0].value=(window.cachedKeys||[]).join("")),t.elm.search.field[0].focus()):t.elm.sidebar&&t.elm.sidebar.iframe&&(e(document).trigger(e.opts.events.openSidebar),t.elm.sidebar.iframe[0].focus()))}),e(window).on("resize",()=>{e("ul."+e.cl.newtab.suggestions).remove()},{passive:!0})},d=()=>{const a=window.webkitSpeechRecognition||window.SpeechRecognition;if(a){if(t.elm.search.wrapper.hasClass(e.cl.newtab.listening)&&t.elm.search.wrapper.data("recognition"))return void t.elm.search.wrapper.data("recognition").stop();const n=new a;t.elm.search.wrapper.data("recognition",n);let l=!1;n.continuous=!1,n.interimResults=!0,n.start(),n.onresult=e=>{let a="",n=!1;for(let t=e.resultIndex;t<e.results.length;++t)a+=e.results[t][0].transcript,e.results[t].isFinal&&(n=!0);a.length>0&&(t.elm.search.field[0].value=a,l=!0),n&&c(a)},n.onstart=()=>{t.elm.search.wrapper.addClass(e.cl.newtab.listening),t.elm.search.field[0].value=t.helper.i18n.get("newtab_speech_search_listening")+" ..."},n.onend=()=>{t.elm.search.wrapper.removeClass(e.cl.newtab.listening),!1===l&&(t.elm.search.field[0].value="")},n.onerror=e=>{n.stop(),n.onend(null),"not-allowed"===e.error&&alert(t.helper.i18n.get("newtab_speech_search_error"))}}}},e.ShortcutsHelper=function(t){this.init=async()=>{this.refreshEntries(),a()},this.refreshEntries=()=>{const a=t.helper.model.getData("n/shortcuts"),n=t.helper.model.getData("n/shortcutsPosition");t.elm.topNav.attr(e.attr.position,n),t.elm.topNav.children("ul").remove();const l=e("<ul />").appendTo(t.elm.topNav);a&&a.length>0&&a.forEach(t=>{const a=e("<li />").appendTo(l);e("<a />").addClass(e.cl.newtab.link).text(t.label).appendTo(a).data("href",t.url).attr("href",t.url)})};const a=()=>{t.elm.topNav.on("click auxclick","a."+e.cl.newtab.link,a=>{a.preventDefault(),0!==a.button&&1!==a.button||t.helper.model.call("openLink",{href:e(a.currentTarget).data("href"),newTab:"auxclick"===a.type,position:t.helper.model.getData("b/newTabPosition"),active:"auxclick"===a.type})})}},e.TopPagesHelper=function(t){let a=null,n=null,l=!1;const r=["thumbnail","favicon"],i={topPages:"default",mostUsed:"most_used",recentlyUsed:"recently_used",pinnedEntries:"pinned_entries",hidden:"hidden"};this.init=async()=>{s(),t.elm.topPages.html("<ul />"),a=t.helper.model.getData("n/topPagesType"),n=t.helper.model.getData("n/topPagesAppearance"),c(),setInterval(()=>{document.hidden&&c()},18e4)},this.getAllTypes=()=>i,this.getAllAppearances=()=>r,this.setType=e=>{a===e&&"hidden"!==a||(a=e,c())},this.setAppearance=e=>{n!==e&&(n=e,c())},this.handleWindowResize=()=>{const e=o(),a=t.elm.topPages.children("ul").data("total");e.total!==a&&c()};const s=()=>{e(window).on("resize.topPages",()=>{this.handleWindowResize()},{passive:!0})},o=()=>{const a={total:8,rows:2},n={w:t.elm.content[0].offsetWidth||window.innerWidth,h:t.elm.content[0].offsetHeight||window.innerHeight},l=e("menu."+e.cl.newtab.infoBar);return l.length()>0&&(n.h-=l[0].offsetHeight),n.w>650?a.total=8:n.w>490?a.total=6:n.w>340?a.total=4:a.total=0,n.h<330?a.total=0:n.h<470&&(a.total/=2,a.rows=1),a},c=()=>{const r=t.elm.topPages.children("ul");r.removeClass(e.cl.visible),"hidden"===a?!1===t.helper.edit.isEditMode()&&r.data("total",0).html(""):!1===l&&(l=!0,Promise.all([d(),e.delay(200)]).then(([a])=>{const l=o();return r.html("").data("total",l.total).attr(e.attr.newtab.appearance,n).attr(e.attr.newtab.perRow,l.total/l.rows),a.forEach(a=>{const l=e("<li />").appendTo(r),i=e("<a />").attr({href:a.url,title:a.title}).appendTo(l),s=e("<span />").text(a.title).appendTo(i);if(t.helper.model.call("favicon",{url:a.url}).then(t=>{if(t.img){const a=e("<img />").attr("src",t.img);"thumbnail"===n?a.prependTo(s):e("<div />").append(a).prependTo(i)}}),"thumbnail"===n){const n=e("<img />").appendTo(i);!1===t.helper.utility.isUrlOnBlacklist(a.url)&&t.helper.model.call("thumbnail",{url:a.url}).then(t=>{t.img&&n.attr("src",t.img).addClass(e.cl.visible)})}}),e.delay(100)}).then(()=>{r.addClass(e.cl.visible),l=!1}))},p=()=>new Promise(e=>{t.helper.entry.init().then(()=>{e()})}),d=()=>new Promise(t=>{const n=o();if(n.total>0)switch(a){case"mostUsed":case"recentlyUsed":p().then(()=>{const e=m(a);t(e)});break;case"pinnedEntries":p().then(()=>{const e=h();t(e)});break;case"topPages":default:e.api.topSites&&e.api.topSites.get&&e.api.topSites.get(a=>{if(void 0===e.api.runtime.lastError&&a){const e=a.slice(0,n.total);t(e)}else t([])})}else t([])}),h=()=>{const e=t.helper.model.getData("u/sort"),a=t.helper.entry.getAllDataByType("pinned"),n=t.helper.model.getData("u/showHidden"),l=o();t.helper.utility.sortEntries(a,e);const r=[];return a.some(e=>{if((n||t.helper.entry.isVisible(e.id))&&!1===t.helper.entry.isSeparator(e.id)&&(r.push(e),r.length>=l.total))return!0}),r},m=e=>{const a=o(),n=[],l=t.helper.model.getData("u/showHidden"),r=t.helper.entry.getAllDataByType("bookmarks");return t.helper.utility.sortEntries(r,{name:e,dir:"DESC"}),r.some(e=>{if((l||t.helper.entry.isVisible(e.id))&&!1===t.helper.entry.isSeparator(e.id)&&0!==e.url.search(/^file:\/\//)&&(n.push(e),n.length>=a.total))return!0}),n}};(new function(){this.elm={body:e("body"),title:e("head > title"),content:e("section#content"),topNav:e("section#content > nav"),search:{wrapper:e("div#search"),field:e("div#search > input[type='text']"),submit:e("div#search > button[type='submit']"),speechSearch:e("div#search > a.speechSearch")},fallbackInfo:e("div#fallbackInfo"),topPages:e("div#topPages")},this.sidebarHelper={},this.enabledSetAsNewtab=!1,this.run=()=>{n(),t();const l=this.helper.template.loading().appendTo(this.elm.body);this.elm.body.addClass(e.cl.initLoading),this.helper.model.init().then(()=>{const t=this.helper.model.getData(["a/darkMode","a/highContrast","b/sidebarPosition"]);return!0===t.darkMode?this.elm.body.addClass(e.cl.page.darkMode):!0===t.highContrast&&this.elm.body.addClass(e.cl.page.highContrast),this.elm.body.attr(e.attr.position,t.sidebarPosition),this.helper.font.init(),this.helper.stylesheet.init(),Promise.all([this.helper.i18n.init(),this.helper.stylesheet.addStylesheets(["newtab"],e(document))])}).then(()=>(this.elm.body.parent("html").attr("dir",this.helper.i18n.isRtl()?"rtl":"ltr"),this.helper.i18n.parseHtml(document),this.helper.topPages.init(),this.helper.search.init(),this.helper.shortcuts.init(),this.helper.fallback.init(),this.helper.edit.init(),a(),Promise.all([this.getBackground(),e.delay(500)]))).then(([t])=>{l.remove(),this.setBackground(t),this.elm.body.removeClass([e.cl.building,e.cl.initLoading]),e(window).trigger("resize")})},this.getBackground=()=>new Promise(t=>{"premium"===this.helper.model.getUserType()?e.api.storage.local.get(["newtabBackground_1"],e=>{e&&e.newtabBackground_1?t(e.newtabBackground_1):t(null)}):t(null)}),this.setBackground=async t=>{null===t?this.elm.body.removeClass(e.cl.newtab.customBackground).css("background-image",""):this.elm.body.addClass(e.cl.newtab.customBackground).css("background-image","url("+t+")")};const t=()=>{this.helper={model:new e.ModelHelper(this),template:new e.TemplateHelper(this),i18n:new e.I18nHelper(this),font:new e.FontHelper(this),stylesheet:new e.StylesheetHelper(this),checkbox:new e.CheckboxHelper(this),utility:new e.UtilityHelper(this),search:new e.SearchHelper(this),overlay:new e.OverlayHelper(this),entry:new e.EntryHelper(this),shortcuts:new e.ShortcutsHelper(this),topPages:new e.TopPagesHelper(this),fallback:new e.FallbackHelper(this),edit:new e.EditHelper(this)}},a=async()=>{e.api.extension.onMessage.addListener(e=>{e&&e.action&&"reinitialize"===e.action&&!1===this.enabledSetAsNewtab&&location.reload(!0)}),e(document).on("keydown",t=>{"Tab"===t.key&&this.elm.sidebar.sidebar.hasClass(e.cl.sidebar.permanent)&&(t.preventDefault(),this.elm.sidebar.iframe[0].focus())}),this.helper.model.getData("n/autoOpen")&&e(window).on("resize",()=>{if(this.elm.sidebar&&this.elm.sidebar.iframe&&this.elm.sidebar.sidebar){const t=this.elm.sidebar.sidebar.realWidth();window.innerWidth-t>=500?(this.elm.sidebar.sidebar.addClass(e.cl.sidebar.permanent),t>0&&this.elm.content.addClass(e.cl.newtab.smallContent),e(document).trigger(e.opts.events.openSidebar),e.delay(500).then(()=>{e(document).trigger("click")})):(this.elm.sidebar.sidebar.removeClass(e.cl.sidebar.permanent),this.elm.content.removeClass(e.cl.newtab.smallContent)),this.helper.topPages.handleWindowResize()}})},n=()=>new Promise(t=>{e("["+e.attr.type+"='script_sidebar']").remove();const a=[e.opts.events.loaded,e.opts.events.elementsCreated].join(" ");e(document).off(a).on(a,t=>{this.elm.sidebar=t.detail.elm,this.sidebarHelper=t.detail.helper,e(window).trigger("resize")}),e.opts.manifest.content_scripts[0].css.forEach(t=>{e("<link />").attr({href:e.api.extension.getURL(t),type:"text/css",rel:"stylesheet",[e.attr.type]:"script_sidebar"}).appendTo("head")});const n=(a=0)=>{const l=e.opts.manifest.content_scripts[0].js[a];if(void 0!==l){const t=document.createElement("script");document.head.appendChild(t),t.onload=()=>n(a+1),t.src="/"+l,e(t).attr(e.attr.type,"script_sidebar")}else t()};n()})}).run()})(jsu);