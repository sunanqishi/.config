var getMicFrame=null,audioStream=null,cameraStream=null,tempVideo=null,MIME_TYPE="video/webm",file_name="/awesome/record.webm",currentId=null,tempFileInfo=null,currentSize=null,currentName=null,fileCreated=!1,currentInfo=null,isRecording=!1,isRecordingPaused=!1,recordingTime=0,recordingTimer=null,lastPausingTime=null,pausedTime=null,isPremium=!1,recordingStartTime=null;function resetData(){dataArray=new ArrayBuffer(0),audioArray=new ArrayBuffer(0)}function getPremium(){return new Promise(function(r,e){chrome.cookies.get({url:"https://www.awesomescreenshot.com",name:"screenshot_personal_type"},function(e){e&&"1"==e.value?r(!0):r(!1)})})}function getFormatName(){var e=new Date;return"AwesomeScreenshot-"+(e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()+"-"+e.getTime())}var baseUrl="https://www.awesomescreenshot.com";function refreshCookie(){$.get(baseUrl+"/promotion_ex")}function goToUpgrade(){var t="https://www.awesomescreenshot.com";chrome.cookies.get({url:t,name:"screenshot_personal_type"},function(e){if(e){if("0"==e.value)var r="/pricing?from=video"}else r="/user/login?type=record_screen";chrome.tabs.create({url:t+r})})}function getMic(){return window.navigator.mediaDevices.getUserMedia({audio:{optional:[{echoCancellation:!1}]}})}function getStream(r){return new Promise(function(t,o){if("tab"==r)chrome.tabCapture.capture({video:!0,videoConstraints:{mandatory:{maxWidth:3840,maxHeight:2160}}},function(e){t(e)});else if("desktop"==r){var e=["screen","window"];"Mac OS"==getOS()&&e.push("audio"),chrome.desktopCapture.chooseDesktopMedia(e,function(e){if(e){var r={audio:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e},optional:[]},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxWidth:3840,maxHeight:2160}}};window.navigator.mediaDevices.getUserMedia(r).then(t).catch(o)}})}})}function setBadge(e,r){"text"===e?chrome.browserAction.setBadgeText({text:r}):"color"===e&&chrome.browserAction.setBadgeBackgroundColor({color:r})}function beginRecord(o){o.isRecordMic&&getMic().then(function(e){audioStream=e}),getStream(o.recordType).then(function(e){if(setBadge("color","red"),0<o.countdown)var r=parseInt(o.countdown),t=setInterval(function(){setBadge("text",r+""),0==r&&(clearInterval(t),setBadge("text","REC"),gotStream(e)),r--},1e3);else gotStream(e)}).catch(function(e){})}function captureTabUsingTabCapture(e){getMic(function(e){audioStream=e});screen.width,screen.height;chrome.desktopCapture.chooseDesktopMedia(["screen","window","audio"],function(e){if(e){var r={audio:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e},optional:[]},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxWidth:2560,maxHeight:1440}}};window.navigator.webkitGetUserMedia(r,function(e){gotStream(e)},function(){})}})}function canvasRecord(e){var r=document.getElementById("desktop-video");r.src=URL.createObjectURL(e),r.play();var t=document.getElementById("tempCanvas"),o=t.getContext("2d");recorder=RecordRTC(t,{type:"canvas"}),e.onended=function(){recorder&&(e.onended=function(){}),audioStream&&audioStream.stop(),recorder.stopped=!0,stopScreenRecording()},e.getVideoTracks()[0].onended=function(){recorder&&e.onended()},function e(){o.drawImage(r,0,0,r.clientWidth,r.clientHeight),window.recorder&&recorder.stopped||requestAnimationFrame(e)}(),recorder.startRecording()}function handleMessage(e){"videodata"==e.data.name?appendVideoData(e.data.data):"videoend"==e.data.name&&fileSaver.save(new Blob([dataArray],{type:"video/webm"}),"AwesomeScreenshot-"+(new Date).toISOString().replace(/:|\./g,"-")+".webm").then(function(e){chrome.runtime.sendMessage({name:"stop"},function(){chrome.tabs.create({url:"/video.html?srcUrl="+e+"&name=record.webm"})})}).catch(function(e){})}function appendVideoData(e){var r=new Uint8Array(dataArray.byteLength+e.byteLength);r.set(new Uint8Array(dataArray),0),r.set(new Uint8Array(e),dataArray.byteLength),dataArray=r.buffer}function handleBlob(r){if(r)if(fileCreated){fileSaver.append(r,currentName),currentSize+=r.size;var e=bytesToSize(currentSize);currentInfo.detail.size=e,currentInfo.detail.duration=recordingTime,DB.update(currentId,currentInfo)}else currentName=getFormatName(),fileSaver.save(r,currentName).then(function(e){fileCreated=!0,currentSize=r.size,tempFileInfo={fileUrl:e,title:currentName,size:bytesToSize(currentSize),duration:recordingTime},DB.save(tempFileInfo).then(function(e){currentId=e.id,currentInfo=e})})}function gotStream(r){var e={type:"video",disableLogs:!1,timeSlice:3e3,ondataavailable:handleBlob,recorderType:MediaStreamRecorder};if(!e.videoCodec)var t="vp9";if(t&&(e.mimeType="video/webm; codecs="+t.toLowerCase()),audioStream){var o=getMixedAudioStream([audioStream,r]);if(o&&o.getAudioTracks().length){ignoreSecondPart=!0;var n=o.getAudioTracks()[0];r.addTrack(n),r.getAudioTracks().forEach(function(e){e!==n&&r.removeTrack(e)})}}recorder=new RecordRTC(r,e);try{recorder.startRecording(),alreadyHadGUMError=!1}catch(e){getUserMediaError()}recorder.stream=r,isRecording=!0,recorder.stream.onended=function(){recorder&&recorder.stream&&(recorder.stream.onended=function(){}),audioStream&&audioStream.stop(),cameraStream&&cameraStream.stop(),stopScreenRecording()},recorder.stream.getVideoTracks()[0].onended=function(){recorder&&recorder.stream&&recorder.stream.onended&&recorder.stream.onended()},recordingStartTime=(new Date).getTime(),recordingTimer=setInterval(updateRecordingTime,100)}function checkTimeLength(e){31e3<=e&&getPremium().then(function(e){e||stopStream()})}function getMixedAudioStream(e){"undefined"==typeof Storage&&(window.Storage={AudioContextConstructor:null,AudioContext:window.AudioContext||window.webkitAudioContext}),Storage.AudioContextConstructor||(Storage.AudioContextConstructor=new Storage.AudioContext);var t=Storage.AudioContextConstructor,o=[],n=t.createGain();n.connect(t.destination);var i=n.gain.value=0;if(e.forEach(function(e){if(e.getAudioTracks().length){i++;var r=t.createMediaStreamSource(e);r.connect(n),o.push(r)}}),i)return mediaStremDestination=t.createMediaStreamDestination(),o.forEach(function(e){e.connect(mediaStremDestination)}),mediaStremDestination.stream}function updateRecordingTime(){if(!isRecordingPaused){var e=(new Date).getTime()-recordingStartTime;pausedTime&&(e-=pausedTime),checkTimeLength(e),setBadge("text",recordingTime=secondsToTime(e))}}function secondsToTime(e){e=Math.floor(e/1e3);var r=Math.floor(e/3600),t=e%60;return t<10&&(t="0"+t),(0<r?r+":":"")+Math.floor((e-3600*r)/60)+":"+t}function setDefaults(){recorder&&recorder.stream&&(recorder.stream.stop(),recorder&&recorder.stream&&recorder.stream.onended&&recorder.stream.onended()),recorder=null,isRecording=!1,tempFileInfo=recordingTime=recordingStartTime=null,imgIndex=0,fileCreated=!1,currentInfo=currentName=currentSize=tempFileInfo=currentId=null}function pauseScreenRecording(){recorder.pauseRecording(),isRecordingPaused=!0,lastPausingTime=(new Date).getTime()}function resumeScreenRecording(){recorder.resumeRecording(),isRecordingPaused=!1,pausedTime=pausedTime+(new Date).getTime()-lastPausingTime}function stopStream(){isRecordingPaused&&resumeScreenRecording(),recorder&&recorder.stream&&recorder.stream.onended()}function restoreRecording(){isRecording=!1,clearInterval(recordingTimer),pausedTime=lastPausingTime=recordingTimer=null,setBadge("text","")}function stopScreenRecording(){restoreRecording(),recorder.stopRecording(function(){googleEvent("record video","record video"),chrome.tabs.create({url:"/video.html?id="+currentId}),setDefaults();try{peer.close(),peer=null}catch(e){}try{audioPlayer.src=null,mediaStremDestination.disconnect(),mediaStremSource.disconnect(),context.disconnect(),context=null}catch(e){}}),recordingTimer&&clearTimeout(recordingTimer)}function getFileSize(e){var r=(e/1024).toFixed(2);return r=r<1024?r.toString().replace(",",".").replace(/\d{1,3}(?=(\d{3})+(?!\d))/g,"$&,")+" KB":(r=(r/1024).toFixed(2)).toString().replace(",",".").replace(/\d{1,3}(?=(\d{3})+(?!\d))/g,"$&,")+" MB"}function saveVideo(){var r="AwesomeScreenshot-"+(new Date).toLocaleString().replace(/\s/g,""),e=(new File([recorder.getBlob()],r+".webm",{type:"video/webm"}),recorder.getBlob()),t=bytesToSize(e.size);fileSaver.save(e,r+".webm").then(function(e){DB.save({fileUrl:e,title:r,size:t,duration:recordingTime}).then(function(e){chrome.runtime.sendMessage({name:"stop"},function(){chrome.tabs.create({url:"/video.html?id="+e}),setDefaults()})})})}function googleEvent(e,r){ga&&ga("send","event","chrome extension",e,r)}function getOS(){window.navigator.userAgent;var e=window.navigator.platform,r=null;return-1!==["Macintosh","MacIntel","MacPPC","Mac68K"].indexOf(e)?r="Mac OS":-1!==["Win32","Win64","Windows","WinCE"].indexOf(e)?r="Windows":!r&&/Linux/.test(e)&&(r="Linux"),r}chrome.cookies.get({url:baseUrl,name:"screenshot_personal_type"},function(e){void 0===e&&refreshCookie()}),$(document).ready(function(){}),DB.init(),window.addEventListener("message",function(e){"audioStream"==e.data.type&&(audioStream=e.data.steam)},!1),chrome.commands.onCommand.addListener(function(e){"stop-recording"===e?stopStream():"pause-or-resume-recording"===e&&(isRecordingPaused?resumeScreenRecording():pauseScreenRecording())});