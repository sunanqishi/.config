var url=window.location.href,id=parseInt(url.match(/\?id=(.*)/)[1]),Bg=chrome.extension.getBackgroundPage(),youtube_prefix="ba9b_",google_prefix="c822_",urlBase="https://preview.diigo.com/api/v3/awe/video/",currentRecord=null,file=null;function updateProgress(e,t){$("#"+e+"-upload").find(".progress-bar-inner").show().css("width",t+"%")}function updateYoutubeProgress(e){return updateProgress("youtube",e)}function updateGDriveProgress(e){return updateProgress("gDrive",e)}function buildYoutubeUrl(e){return"https://youtu.be/"+e}function beginUpload(e){$("#"+e+"-upload").addClass("uploading").find(".progress-bar").show()}function afterUpload(e,t,n){var o=$("#"+e+"-upload");o.removeClass("uploading").addClass("uploaded"),o.find(".progress-bar").hide().find(".progress-bar-inner").css("width",0),o.find(".url-area").show().find("input").val(t),n||(currentRecord.detail[e+"Url"]=t,DB.update(id,currentRecord))}function init(){function t(o){chrome.downloads.download(o,function(e){if(void 0===e||chrome.runtime.lastError){var t=document.createElement("a"),n=document.createEvent("MouseEvents");n.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),t.setAttribute("href",o.url),t.setAttribute("download",o.filename),t.dispatchEvent(n)}})}$("#uploadToYoutube").on("click",function(){getFile($("#video").attr("src")).then(function(e){return beginUpload("youtube"),file||(file=new File([e],"AwesomeScreenshot-"+(new Date).toISOString().replace(/:|\./g,"-")+".webm",{type:"video/webm"})),uploadVideo.uploadToYoutube(file,updateYoutubeProgress)}).then(function(e){afterUpload("youtube",buildYoutubeUrl(e.id))}).catch(function(e){})}),$("#uploadToGdrive").on("click",function(){getFile($("#video").attr("src")).then(function(e){return beginUpload("gDrive"),file||(file=new File([e],"AwesomeScreenshot-"+(new Date).toISOString().replace(/:|\./g,"-")+".webm",{type:"video/webm"})),uploadVideo.uploadToGoogleDrive(file,updateGDriveProgress)}).then(function(e){afterUpload("gDrive",e.alternateLink)}).catch(function(e){})}),$("#delete-record").on("click",function(){confirm("Are you sure to delete this recording?")&&DB.delete(id).then(function(e){window.close()})}),document.getElementById("video").addEventListener("canplay",function(){makeThumbnail()}),$("#manage-record").on("click",function(){window.location.href="/video-list.html"}),$("#download-record, .download-btn").on("click",function(){chrome.permissions.request({permissions:["downloads"]},function(e){e&&getFile(currentRecord.fileUrl).then(function(e){e.size<1442116762?getSeekableBlob(e,function(e){t({url:URL.createObjectURL(e),filename:currentRecord.detail.title+".webm",saveAs:!0})}):t({url:URL.createObjectURL(e),filename:currentRecord.detail.title+".webm",saveAs:!0})})})}),$("#display-text").on("click",function(){var e=$("#video-title");e.addClass("editing"),e.find("input").css("width",e.width()-200).focus()}),$("#video-title").find("input").on("blur",function(){var e=$("#display-text").find(".text").text().trim(),t=$(this).val().trim();""!=t.replace(" ","")?($("#video-title").removeClass("editing"),e!==t&&($("#display-text").find(".text").text(t),currentRecord.detail.title=t,DB.update(id,currentRecord))):alert("Title can not be empty!")}),$(".upload-item-detail").find("input").on("focus",function(){$(this).select(),document.execCommand("copy"),$(this).parents(".upload-item").find(".copy-tip").fadeIn("fast").delay(1e3).fadeOut("fast")}),DB.init().then(function(){DB.get(id).then(function(e){buildRecord(currentRecord=e)})}),Bg.getPremium().then(function(e){e&&$(".tip").hide()}),$("#upgrade-btn").on("click",function(){Bg.googleEvent("upgrade from video page","upgrade"),Bg.goToUpgrade()})}function buildRecord(e){var t=e.detail;$("#video").attr("src",e.fileUrl),$("#video")[0].currentTime=9999999999,document.title=t.title,$(".video-title").find("input").val(t.title),$("#display-text").find(".text").text(t.title),$("#info-time").text(formatDate(new Date(t.timeStamp))),$("#info-duration").text(t.duration),$("#info-size").text(t.size),t.youtubeUrl&&afterUpload("youtube",t.youtubeUrl,!0),t.gDriveUrl&&afterUpload("gDrive",t.gDriveUrl,!0)}function makeThumbnail(){var e=document.createElement("canvas");e.width=320,e.height=180;var t=e.getContext("2d"),n=document.getElementById("video");t.drawImage(n,0,0,e.width,e.height);var o=e.toDataURL(),i=b64toBlob(o.split(",")[1],o.split(",")[0].split(":")[1].split(";")[0]);fileSaver.save(i,currentRecord.id+"_thumbnail.png").then(function(e){currentRecord.detail.thumbnailUrl=e,DB.update(id,currentRecord)})}function formatDate(e){var t=e.getDate(),n=e.getMonth(),o=e.getFullYear();return["Jan","Feb","Mar","Apr","May","June","July","Aug","Sep","Oct","Nov","Dec"][n]+" "+t+", "+o}function getSeekableBlob(e,i){if("undefined"==typeof EBML)throw new Error("Please link: https://cdn.webrtc-experiment.com/EBML.js");var r=new EBML.Reader,a=new EBML.Decoder,u=EBML.tools,t=new FileReader;t.onload=function(e){a.decode(this.result).forEach(function(e){r.read(e)}),r.stop();var t=u.makeMetadataSeekable(r.metadatas,r.duration,r.cues),n=this.result.slice(r.metadataSize),o=new Blob([t,n],{type:"video/webm"});i(o)},t.readAsArrayBuffer(e)}function b64toBlob(e,t,n){function o(e){return e.charCodeAt(0)}t=t||"",n=n||1024;for(var i=atob(e),r=[],a=0;a<i.length;a+=n){var u=i.slice(a,a+n),d=Array.prototype.map.call(u,o),l=new Uint8Array(d);r.push(l)}return new Blob(r,{type:t})}function getFile(o){return new Promise(function(n,e){var t=new XMLHttpRequest;t.open("GET",o,!0),t.responseType="blob",t.onload=function(e){if(200==this.status){var t=this.response;n(t)}},t.send()})}function isShareLinkReady(){setTimeout(function(){var t=$.get(urlBase+name,function(e){e.code?(t.abort(),isShareLinkReady()):($("#share").removeClass("disabled"),$("#share-input").find("input").val(urlBase+name))})},1e3)}Bg.googleOAuth.getAccount().accessToken&&($("#current-account").show(),$("#c-email").find("span").text(Bg.googleOAuth.getAccount().email)),localStorage.temp_camera_url&&(document.getElementById("video2").style.display="block",document.getElementById("video2").setAttribute("src",localStorage.temp_camera_url)),$("#share").on("click",function(){$(this).hasClass("disabled")||$("#share-input").show()}),$("#c-email").on("click",function(){$("#notice").toggle()}),$("#gdrive-signout").on("click",function(){Bg.googleOAuth.clearAccount(),$("#current-account").hide(),$("#notice").hide()}),init();